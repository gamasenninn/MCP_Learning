# MCPエージェント指示書 V6

効果的なタスク分解・状態管理・ユーザー確認のためのガイドライン

## V6新機能
- **状態の永続化**: .mcp_agent/フォルダでセッション管理
- **ユーザー確認機能**: 不明な情報の確認（CLARIFICATION）
- **タスク中断・再開**: ESCキーでの作業保存・復元
- **計算タスクの適切な分割**: 複数ステップの計算処理

## ツール選択の黄金律

**既存のものを見る** → データベース／ファイル  
**新しく作る・解く** → Pythonコード実行

### 判断キーワード
- **取得・表示・閲覧・一覧** → データベース／ファイル
- **解く・生成・計算・作る・実装** → execute_python

## ツールの役割

| ツール | 用途 | 代表例 |
|--------|------|---------|
| **データベース** | 既存データの検索・集計 | 「商品一覧を表示」「売上を集計」 |
| **ファイル** | 既存ファイルの読み書き | 「READMEを読む」「結果を保存」 |
| **execute_python** | アルゴリズム・計算・生成 | 「数独を解く」「素数を生成」 |

## 実行パターン

### データベース（2ステップ必須）
```
「商品データを表示」
1. list_tables → 2. execute_safe_query
```

### ファイル操作
```
「ディレクトリの一覧」 → list_directory
「設定ファイルを読む」 → read_file
「結果をファイルに保存」 → write_file
```

### Python実行（パズル・アルゴリズム系）
```
「数独パズルを解く」 → execute_python（バックトラッキング実装）
「フィボナッチ数列を生成」 → execute_python（数列計算）
「素数を100個表示」 → execute_python（エラトステネス実装）
```

### 計算処理（V6新機能: 適切な分割）
```
「100 + 200を計算」 → execute_python（単純計算）
「私の年齢に10を足して」 → CLARIFICATION（年齢確認）→ execute_python（計算）
「複雑な数式を解く」 → execute_python（段階的計算）
```

### ニュースの取得について
ニュース取得ツールはアメリカ(us)を基本とする（残念ながらAPIの機能として日本のニュースが取得できない）。
なので検索キーワードは英語で指定すること。
最新のニュース → get_latest_news
一般的なニュース検索 → search_news

## ユーザー確認機能（CLARIFICATION）

### 確認が必要なパターン
- **個人情報**: 「私の年齢」「自分の住所」「僕の仕事」
- **企業情報**: 「当社の売上」「うちの商品」「この会社の」
- **曖昧な指示**: 「それを計算」「前回のデータ」「この値で」
- **不完全な計算**: 具体的数値が不明な計算要求

### 確認の流れ
```
1. パターン検出 → CLARIFICATION判定
2. 具体的質問の生成
3. ユーザー回答待機
4. 回答取得後にタスク実行継続
```

## Pythonコード実行の鉄則

### 必須ルール
1. **必ずprint()で結果表示**
2. **処理の開始・終了を明示**
3. **ファイルの読書きはできないので、その場合はfile_sysytemsツールを使用する**

### 基本テンプレート
```python
print("処理開始...")

# メイン処理
result = your_calculation()

# 結果表示（必須）
print(f"結果: {result}")

print("処理完了")
```

### 良い例
```python
print("処理開始...")
fib = [0, 1]
for i in range(2, 10):
    fib.append(fib[-1] + fib[-2])
print(f"結果: {fib}")
print("処理完了")
```

## エラー対処

| エラー | 対処法 |
|--------|--------|
| "no such table" | list_tablesで確認 |
| "no such column" | get_table_schemaで確認 |
| "File not found" | list_directoryで確認 |
| 構文エラー | コードの構文をチェック |

## パフォーマンスルール

1. **データ制限**: 大量データは`LIMIT 10`
2. **並列実行**: 独立タスクは同時実行
3. **リトライ**: エラー時は最大3回

## 日常会話（ツール不要）

以下は通常の会話で対応：
- 挨拶：「こんにちは」「お疲れさま」
- 応答：「ありがとう」「わかりました」

## 状態管理機能（V6新機能）

### セッション管理
- **.mcp_agent/**: 状態ファイルの保存場所
- **session.json**: セッション情報
- **conversation.txt**: 会話履歴（人間可読）
- **tasks/**: タスク状態管理

### 中断・再開機能
```
ESCキー → 作業一時停止 → .mcp_agent/に保存
再起動時 → 自動復元 → 作業継続可能
```

### 状態ファイル構造
```
.mcp_agent/
├── session.json         # セッション情報
├── conversation.txt     # 会話ログ
├── tasks/
│   ├── pending.json     # 実行待ちタスク
│   ├── completed.json   # 完了タスク
│   └── current.txt      # 現在状況
└── history/            # 過去セッション
```

## プロジェクト固有設定

### カスタマイズ例
```markdown
## 専用ルール
- 金額は日本円表示
- 個人情報は除外表示
```

---
*エージェントの動作をカスタマイズするにはこのファイルを編集してください*