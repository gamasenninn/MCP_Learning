# MCP Agent V6

Claude Codeé¢¨ã®å¯¾è©±å‹MCPã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ - çŠ¶æ…‹ç®¡ç†ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ç¢ºèªæ©Ÿèƒ½ã‚’æ­è¼‰

## ğŸ†• V6 æ–°æ©Ÿèƒ½

### çŠ¶æ…‹ã®æ°¸ç¶šåŒ–
- **.mcp_agent/ãƒ•ã‚©ãƒ«ãƒ€**: ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã‚’ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã§ç®¡ç†
- **ä¼šè©±å±¥æ­´ã®æ°¸ç¶šåŒ–**: ã™ã¹ã¦ã®ä¼šè©±ãŒä¿å­˜ãƒ»å¾©å…ƒå¯èƒ½
- **ã‚¿ã‚¹ã‚¯çŠ¶æ…‹ç®¡ç†**: å®Ÿè¡Œå¾…ã¡ãƒ»å®Œäº†ã‚¿ã‚¹ã‚¯ã®çŠ¶æ…‹è¿½è·¡

### ãƒ¦ãƒ¼ã‚¶ãƒ¼ç¢ºèªæ©Ÿèƒ½ï¼ˆCLARIFICATIONï¼‰
- **ä¸æ˜ãªæƒ…å ±ã®æ¤œå‡º**: ã€Œç§ã®å¹´é½¢ã€ã€Œå½“ç¤¾ã®å£²ä¸Šã€ç­‰ã‚’è‡ªå‹•æ¤œå‡º
- **å¯¾è©±çš„ãªç¢ºèª**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å…·ä½“çš„ãªè³ªå•ã‚’æŠ•ã’ã‹ã‘
- **ã‚¿ã‚¹ã‚¯ç¶™ç¶š**: å›ç­”ã‚’å—ã‘ã¦å‡¦ç†ã‚’ç¶™ç¶š

### ã‚¿ã‚¹ã‚¯ä¸­æ–­ãƒ»å†é–‹
- **ESCã‚­ãƒ¼å¯¾å¿œ**: ä½œæ¥­ä¸­æ–­æ™‚ã«çŠ¶æ…‹ã‚’è‡ªå‹•ä¿å­˜
- **ã‚»ãƒƒã‚·ãƒ§ãƒ³å¾©å…ƒ**: å†èµ·å‹•æ™‚ã«å‰å›ã®ç¶šãã‹ã‚‰å®Ÿè¡Œ
- **ã‚¿ã‚¹ã‚¯ä¾å­˜é–¢ä¿‚**: å‰ã®ã‚¿ã‚¹ã‚¯çµæœã‚’åˆ©ç”¨ã—ãŸå‡¦ç†

### è¨ˆç®—ã‚¿ã‚¹ã‚¯ã®æ”¹å–„
- **é©åˆ‡ãªåˆ†å‰²**: è¤‡é›‘ãªè¨ˆç®—ã‚’æ®µéšçš„ã«å‡¦ç†
- **ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è§£æ±º**: å‹•çš„ãªå€¤ã®ç½®æ›ã¨æ¨è«–
- **ã‚¨ãƒ©ãƒ¼å‡¦ç†**: å¤±æ•—æ™‚ã®è‡ªå‹•ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½

## ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

```
chapter10_v6/
â”œâ”€â”€ mcp_agent.py          # ãƒ¡ã‚¤ãƒ³ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆï¼ˆV6å¯¾å¿œï¼‰
â”œâ”€â”€ state_manager.py     # ğŸ†• çŠ¶æ…‹ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 
â”œâ”€â”€ task_manager.py      # ğŸ†• ã‚¿ã‚¹ã‚¯ç®¡ç†ï¼†CLARIFICATION
â”œâ”€â”€ prompts.py           # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼ˆV6å¯¾å¿œï¼‰
â”œâ”€â”€ AGENT.md            # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆæŒ‡ç¤ºæ›¸ï¼ˆV6æ›´æ–°ï¼‰
â”œâ”€â”€ connection_manager.py # MCPæ¥ç¶šç®¡ç†
â”œâ”€â”€ display_manager.py   # UIè¡¨ç¤ºç®¡ç†
â”œâ”€â”€ error_handler.py     # ã‚¨ãƒ©ãƒ¼å‡¦ç†
â”œâ”€â”€ utils.py            # ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
â”œâ”€â”€ config.yaml         # è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«
â”œâ”€â”€ tests/              # ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«
â”‚   â”œâ”€â”€ test_state_manager.py
â”‚   â”œâ”€â”€ test_task_manager.py
â”‚   â””â”€â”€ test_v6_integration.py
â””â”€â”€ docs/               # ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
```

## ğŸ”§ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

### 1. ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```bash
# uvã‚’ä½¿ç”¨ï¼ˆæ¨å¥¨ï¼‰
uv add openai pyyaml rich

# ã¾ãŸã¯ pip
pip install openai pyyaml rich
```

### 2. è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®æº–å‚™

```bash
# config.sample.yaml ã‚’ config.yaml ã«ã‚³ãƒ”ãƒ¼
cp config.sample.yaml config.yaml

# OpenAI API ã‚­ãƒ¼ã‚’è¨­å®š
# config.yaml ã® api_key: "your-api-key-here" ã‚’ç·¨é›†
```

### 3. ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®èµ·å‹•

```bash
# åŸºæœ¬èµ·å‹•
uv run python mcp_agent.py

# ç‰¹å®šã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã§å†é–‹
python mcp_agent.py --session session_20241201_143022
```

## ğŸš€ ä½¿ç”¨ä¾‹

### åŸºæœ¬çš„ãªä½¿ã„æ–¹

```
Agent> ã“ã‚“ã«ã¡ã¯
ã“ã‚“ã«ã¡ã¯ï¼ä½•ã‹ãŠæ‰‹ä¼ã„ã§ãã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ

Agent> ç§ã®å¹´é½¢ã«10ã‚’è¶³ã—ã¦è¨ˆç®—ã—ã¦
### ç¢ºèªãŒå¿…è¦ã§ã™

å¹´é½¢ã‚’æ•™ãˆã¦ãã ã•ã„ã€‚

**èƒŒæ™¯æƒ…å ±:**
è¦æ±‚: ç§ã®å¹´é½¢ã«10ã‚’è¶³ã—ã¦è¨ˆç®—ã—ã¦
ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§ã€Œç§ã®å¹´é½¢ã€ãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã™ãŒã€å…·ä½“çš„ãªå€¤ãŒã‚ã‹ã‚Šã¾ã›ã‚“ã€‚

**ä¾‹:**
- ä¾‹: 25æ­³
- ä¾‹: 30æ­³ã§ã™
- ä¾‹: ç§ã®å¹´é½¢ã¯28æ­³

> å›ç­”ã‚’ãŠå¾…ã¡ã—ã¦ã„ã¾ã™ã€‚ESCã‚­ãƒ¼ã§ä½œæ¥­ã‚’ä¸­æ–­ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚

Agent> 25æ­³ã§ã™
ã‚¿ã‚¹ã‚¯ãŒå®Œäº†ã—ã¾ã—ãŸ: å¹´é½¢ã«10ã‚’åŠ ç®—ã—ã¦è¨ˆç®—
çµæœ: 35
```

### ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†

```python
# ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã®ç¢ºèª
agent.get_session_status()

# ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸€æ™‚åœæ­¢
await agent.pause_session()

# ã‚»ãƒƒã‚·ãƒ§ãƒ³å†é–‹
await agent.resume_session()

# ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¯ãƒªã‚¢
await agent.clear_session()
```

## ğŸ“Š çŠ¶æ…‹ãƒ•ã‚¡ã‚¤ãƒ«æ§‹é€ 

V6ã§ã¯ `.mcp_agent/` ãƒ•ã‚©ãƒ«ãƒ€ã«ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã¾ã™ï¼š

```
.mcp_agent/
â”œâ”€â”€ session.json         # ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±
â”œâ”€â”€ conversation.txt     # ä¼šè©±ãƒ­ã‚°ï¼ˆäººé–“å¯èª­ï¼‰
â”œâ”€â”€ tasks/
â”‚   â”œâ”€â”€ pending.json     # å®Ÿè¡Œå¾…ã¡ã‚¿ã‚¹ã‚¯
â”‚   â”œâ”€â”€ completed.json   # å®Œäº†ã‚¿ã‚¹ã‚¯
â”‚   â””â”€â”€ current.txt      # ç¾åœ¨ã®çŠ¶æ³ï¼ˆäººé–“å¯èª­ï¼‰
â””â”€â”€ history/            # éå»ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³
    â”œâ”€â”€ session_20241201_143022.json
    â””â”€â”€ session_20241201_143022_conversation.txt
```

## ğŸ§ª ãƒ†ã‚¹ãƒˆ

V6ã®æ–°æ©Ÿèƒ½ã‚’ãƒ†ã‚¹ãƒˆã§ãã¾ã™ï¼š

```bash
# çŠ¶æ…‹ç®¡ç†ã®ãƒ†ã‚¹ãƒˆ
uv run python tests/test_state_manager.py

# ã‚¿ã‚¹ã‚¯ç®¡ç†ã®ãƒ†ã‚¹ãƒˆ  
uv run python tests/test_task_manager.py

# çµ±åˆãƒ†ã‚¹ãƒˆ
uv run python tests/test_v6_integration.py

# å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
uv run python tests/test_import_check.py
```

## ğŸ”„ ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

### V5ã‹ã‚‰V6ã¸ã®ç§»è¡Œ

V6ã§ã¯æ–°ã—ã„çŠ¶æ…‹ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ãŒå°å…¥ã•ã‚Œã¦ã„ã¾ã™ã€‚æ—¢å­˜ã®V5ç’°å¢ƒã‹ã‚‰ç§»è¡Œã™ã‚‹å ´åˆï¼š

1. **è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«**: `config.yaml` ã¯ãã®ã¾ã¾ä½¿ç”¨å¯èƒ½
2. **AGENT.md**: V6å¯¾å¿œç‰ˆã«æ›´æ–°ï¼ˆCLARIFICATIONãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è¿½åŠ ï¼‰
3. **çŠ¶æ…‹ãƒ•ã‚¡ã‚¤ãƒ«**: æ–°è¦ä½œæˆï¼ˆ`.mcp_agent/` ãƒ•ã‚©ãƒ«ãƒ€ï¼‰

## âš™ï¸ V6è¨­å®šé …ç›®

`config.yaml` ã§V6ç‰¹æœ‰ã®è¨­å®šã‚’èª¿æ•´ã§ãã¾ã™ï¼š

```yaml
# V6çŠ¶æ…‹ç®¡ç†è¨­å®š
state_management:
  state_dir: ".mcp_agent"
  auto_save_interval: 30  # ç§’
  max_conversation_history: 50
  session_timeout: 3600   # ç§’

# CLARIFICATIONè¨­å®š  
clarification:
  enable_clarification: true
  auto_detect_patterns: true
  max_clarification_attempts: 3

# ã‚¿ã‚¹ã‚¯å®Ÿè¡Œè¨­å®š
task_execution:
  enable_task_persistence: true
  auto_resume_on_startup: true
  max_pending_tasks: 20
```

## ğŸ†š ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ¯”è¼ƒ

| æ©Ÿèƒ½ | V5 | V6 |
|------|----|----|
| åŸºæœ¬å®Ÿè¡Œ | âœ… | âœ… |
| ã‚¿ã‚¹ã‚¯åˆ†è§£ | âœ… | âœ… |
| ä¼šè©±å±¥æ­´ | ãƒ¡ãƒ¢ãƒªã®ã¿ | æ°¸ç¶šåŒ– |
| çŠ¶æ…‹ç®¡ç† | ãªã— | âœ… |
| ãƒ¦ãƒ¼ã‚¶ãƒ¼ç¢ºèª | ãªã— | âœ… |
| ã‚¿ã‚¹ã‚¯ä¸­æ–­ãƒ»å†é–‹ | ãªã— | âœ… |
| è¨ˆç®—åˆ†å‰² | åŸºæœ¬çš„ | é«˜åº¦ |

## ğŸ› ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã‚ˆãã‚ã‚‹å•é¡Œ

1. **çŠ¶æ…‹ãƒ•ã‚¡ã‚¤ãƒ«ã®æ¨©é™ã‚¨ãƒ©ãƒ¼**
   ```bash
   # .mcp_agent ãƒ•ã‚©ãƒ«ãƒ€ã®æ¨©é™ã‚’ç¢ºèª
   ls -la .mcp_agent/
   chmod -R 755 .mcp_agent/
   ```

2. **ã‚»ãƒƒã‚·ãƒ§ãƒ³å¾©å…ƒå¤±æ•—**
   ```bash
   # ç ´æã—ãŸã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã®å‰Šé™¤
   rm -rf .mcp_agent/session.json
   ```

3. **CLARIFICATION ãŒå‹•ä½œã—ãªã„**
   - `config.yaml` ã® `enable_clarification: true` ã‚’ç¢ºèª
   - AGENT.md ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒæ­£ã—ã„ã‹ç¢ºèª

### ãƒ­ã‚°ã¨ãƒ‡ãƒãƒƒã‚°

```yaml
# config.yaml ã§ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’æœ‰åŠ¹åŒ–
development:
  verbose: true
  show_api_calls: true
  debug_state_management: true
```

## ğŸ¤ è²¢çŒ®

V6ã®æ”¹å–„ã«ã”å”åŠ›ãã ã•ã„ï¼š

1. **Issueå ±å‘Š**: ãƒã‚°ã‚„æ”¹å–„ææ¡ˆã‚’ãŠå¯„ã›ãã ã•ã„
2. **ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹**: æ–°ã—ã„ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ªã®ä½œæˆ
3. **ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**: ä½¿ç”¨ä¾‹ã‚„è¨­å®šä¾‹ã®è¿½åŠ 

## ğŸ“„ ãƒ©ã‚¤ã‚»ãƒ³ã‚¹

ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯ã‚ªãƒ¼ãƒ—ãƒ³ã‚½ãƒ¼ã‚¹ã§ã™ã€‚è©³ç´°ã¯ LICENSE ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã”è¦§ãã ã•ã„ã€‚

---

**MCP Agent V6** - ã‚ãªãŸã®ä½œæ¥­ã‚’ä¸­æ–­ã•ã‚Œã‚‹ã“ã¨ãªãã€ç¢ºå®Ÿã«å®Œäº†ã¾ã§å°ãã¾ã™ã€‚