# 潜在バグリスト - MCP Agent V4

**作成日**: 2025-08-23  
**優先度**: 🔴高 🟡中 🟢低

---

## 🔴 緊急対応必須（システムクラッシュリスク）

### Bug #1: プレースホルダー無限再帰
- **ファイル**: `mcp_agent.py:305-367`
- **トリガー**: 循環参照プレースホルダー（例：`{{task_1.result}}` → `{{task_2.result}}` → `{{task_1.result}}`）
- **影響**: スタックオーバーフロー → プロセス終了
- **再現手順**: 
  1. タスク1でresult: "{{task_2.city}}"
  2. タスク2でparams: {"city": "{{task_1.result}}"}
- **修正期限**: 即座

### Bug #2: f-string注入脆弱性
- **ファイル**: `prompts.py` 全プロンプトメソッド
- **トリガー**: ユーザー入力に波括弧が含まれる場合
- **例**: ユーザーが`"{test}"`と入力 → KeyError
- **影響**: アプリケーション異常終了
- **修正期限**: 即座

### Bug #3: 非同期リソースリーク
- **ファイル**: `connection_manager.py:115`
- **トリガー**: サーバー接続中の例外発生
- **影響**: プロセス・ファイルハンドル残存
- **症状**: 長時間実行でリソース枯渇
- **修正期限**: 1日以内

### Bug #4: Rich UI リソースリーク
- **ファイル**: `display_manager_rich.py:383`
- **トリガー**: ライブ更新中の例外発生
- **影響**: バックグラウンドスレッド残存
- **修正期限**: 1日以内

---

## 🟡 中優先度（機能不全リスク）

### Bug #5: 統計データ競合
- **ファイル**: `mcp_agent.py:635,651`
- **トリガー**: 複数タスクの並行実行
- **影響**: 統計値の不整合
- **症状**: 成功数と失敗数の合計が不正
- **修正期限**: 1週間

### Bug #6: エラー分類の誤判定
- **ファイル**: `error_handler.py:61-65`
- **トリガー**: パスに数字が含まれるAPI（例：`/v404/endpoint`）
- **影響**: 不適切なリトライ戦略
- **修正期限**: 1週間

### Bug #7: メモリ使用量爆発
- **ファイル**: `mcp_agent.py:282`
- **トリガー**: 10個以上のタスクチェーン
- **影響**: メモリ不足エラー
- **計算**: N個タスク → O(N²)メモリ使用
- **修正期限**: 2週間

### Bug #8: JSON解析失敗
- **ファイル**: `error_handler.py:148-150`
- **トリガー**: ネストした波括弧を持つLLM応答
- **例**: `{"data": {"nested": {"value": 1}}}`
- **影響**: パラメータ自動修正機能停止
- **修正期限**: 2週間

---

## 🟢 低優先度（利便性向上）

### Bug #9: ゼロ除算エラー
- **ファイル**: `display_manager.py:158`
- **トリガー**: `total=0`でのプログレス表示
- **影響**: ZeroDivisionError
- **修正期限**: 1ヶ月

### Bug #10: 端末幅誤判定
- **ファイル**: `display_manager.py:213`
- **トリガー**: 幅80文字未満の端末
- **影響**: 表示崩れ
- **修正期限**: 1ヶ月

### Bug #11: 型不整合
- **ファイル**: 複数
- **例**: `config["display"]["show_timing"]` が存在しない場合
- **影響**: KeyError
- **修正期限**: 2ヶ月

### Bug #12: 重複インポート
- **ファイル**: `display_manager_rich.py:323`
- **トリガー**: show_tool_call呼び出し
- **影響**: わずかなパフォーマンス低下
- **修正期限**: 2ヶ月

---

## 🎯 修正戦略

### 緊急対応プラン（24時間以内）
```python
# Bug #1 対策例
def _resolve_placeholders(self, params: Dict, execution_context: List[Dict], _depth=0) -> Dict:
    if _depth > 10:  # 循環参照防止
        raise ValueError("プレースホルダー循環参照を検出")
    # ... 既存コード
```

### 中期対策（1-2週間）
1. 統計データの`asyncio.Lock()`による保護
2. 正規表現エラーパターンの精密化
3. shallow copyによるメモリ使用量削減

### 長期改善（1-2ヶ月）
1. 型ヒント完全対応
2. 包括的ユニットテストスイート
3. 静的解析ツール統合

---

## 📋 テストケース追加リスト

### 必須テストケース
1. **循環プレースホルダーテスト**
   ```python
   def test_circular_placeholder():
       # {{task_1}} → {{task_2}} → {{task_1}} のパターン
   ```

2. **f-string注入テスト**
   ```python
   def test_fstring_injection():
       user_input = "{malicious_code}"
       # 例外が発生しないことを確認
   ```

3. **リソースリークテスト**
   ```python
   def test_connection_leak():
       # 接続例外後のリソース確認
   ```

### 推奨テストケース
4. 並行実行時の統計データ整合性
5. 大量タスク実行時のメモリ使用量
6. エラー分類の精度

---

## 🚨 緊急時対応手順

### システムクラッシュ時
1. プロセス強制終了: `taskkill /f /im python.exe`
2. 残存リソース確認: `netstat -an | findstr :PORT`
3. 一時的回避策: 該当機能の無効化

### メモリリーク検出時
1. メモリ使用量監視: `psutil.virtual_memory()`
2. オブジェクト参照カウント確認: `sys.getrefcount()`
3. ガベージコレクション強制実行: `gc.collect()`

---

**更新履歴**:
- 2025-08-23: 初版作成
- 次回更新: Bug修正後