# 第10章 MCPエージェントを作る

## 概要

第10章では、第9章で作成したLLM統合MCPクライアントをベースに、より高度な機能を持つMCPエージェントを構築しました。

主な追加機能：
- **タスクマネージャー**: 複雑なタスクを自動的に分解し、順次実行
- **エラーハンドリング**: エラーの自動検出、分類、リトライ戦略の実装
- **統合エージェント**: 両機能を統合した実用的なMCPエージェント

## ファイル構成

### コアモジュール

1. **task_manager.py**
   - `SimpleTaskManager`: タスクの登録、実行、状態管理
   - `Task`: タスク定義のデータクラス
   - 依存関係の処理とタスクキューの管理

2. **error_handler.py**
   - `BasicErrorHandler`: エラーの分類と処理
   - エラーパターンマッチング
   - リトライ戦略（exponential backoff）
   - エラー統計とレポート機能

3. **mcp_agent.py**
   - `MCPAgent`: 統合エージェントクラス
   - タスクマネージャーとエラーハンドラーの統合
   - 対話型インターフェース
   - クエリのタスク分解機能

### 実行スクリプト

- **run_agent.py**: エージェント起動用のメインスクリプト
- **test_agent.py**: 統合テストスクリプト

### 第9章からの継承ファイル

- **mcp_llm_final.py**: LLM統合の完全版
- **mcp_llm_step1.py**: ツール収集機能
- **mcp_llm_step2.py**: LLM統合準備
- その他のサポートファイル

## 実行方法

### 基本的な起動

```bash
cd C:\MCP_Learning\chapter10
uv run python run_agent.py
```

### テストの実行

```bash
# 統合テスト
uv run python test_agent.py

# 個別モジュールのテスト
uv run python task_manager.py    # タスクマネージャーのテスト
uv run python error_handler.py    # エラーハンドラーのテスト
```

### 対話モードでの使用

```bash
uv run python mcp_agent.py
```

## 主な機能

### 1. タスクマネージャー

- **タスクの自動分解**: 複雑なクエリを実行可能な小さなタスクに分解
- **依存関係の管理**: タスク間の依存関係を考慮した順次実行
- **実行状態の追跡**: pending/running/completed/failed/skipped
- **実行時間の計測**: 各タスクの実行時間を記録
- **レポート機能**: 実行結果の詳細レポート生成

### 2. エラーハンドリング

- **エラーの自動分類**: 接続エラー、タイムアウト、権限エラーなど
- **重要度判定**: low/medium/high/critical
- **自動リトライ**: エラータイプに応じたリトライ戦略
- **Exponential Backoff**: リトライ間隔の段階的増加
- **統計情報**: エラー発生率、解決率の追跡

### 3. 統合エージェント

- **自然言語処理**: ユーザーのクエリを理解し適切に処理
- **ツール実行**: MCPツールの自動選択と実行
- **会話履歴**: コンテキストを保持した対話
- **リアルタイム表示**: 実行状況の可視化

## 使用例

### 簡単なクエリ

```
あなた> 電卓で123+456を計算して
エージェント> 計算結果は579です。
```

### 複雑なタスク

```
あなた> データを取得して、処理して、結果を保存して
エージェント> タスク実行が完了しました。
- 実行タスク数: 3
- 成功: 3
- 実行時間: 5.2秒

実行結果:
[OK] データ取得: データを正常に取得しました
[OK] データ処理: 処理が完了しました
[OK] 結果保存: 保存に成功しました
```

### コマンド

```
あなた> stats
[統計情報]
セッション開始: 2025-01-16 10:00:00
ツール呼び出し: 5回
エラー発生: 2回
タスク完了: 10個
エラー解決率: 50.0%

あなた> report
タスク実行レポート
====================
[ステータスサマリ]
  pending: 0
  completed: 10
  failed: 2
...

あなた> reset
タスクマネージャーと会話履歴をリセットしました。
```

## 技術的な特徴

1. **非同期処理**: asyncioを使用した効率的な並行処理
2. **エラー耐性**: 一部のタスクが失敗しても継続可能
3. **拡張性**: 新しいタスクタイプやエラーパターンの追加が容易
4. **デバッグ機能**: verboseモードによる詳細なログ出力

## トラブルシューティング

### よくある問題

1. **モジュールが見つからない**
   ```bash
   uv pip install fastmcp openai python-dotenv
   ```

2. **OpenAI APIキーエラー**
   - `.env`ファイルにAPIキーを設定
   ```
   OPENAI_API_KEY=your-api-key
   ```

3. **MCPサーバー接続エラー**
   - `mcp_servers.json`の設定を確認
   - サーバーのパスが正しいか確認

## 今後の拡張可能性

1. **並列実行**: 依存関係のないタスクの並列処理
2. **学習機能**: エラーパターンの自動学習
3. **UI改善**: Webインターフェースの追加
4. **プラグイン機構**: カスタムタスクハンドラーの追加
5. **永続化**: タスク履歴のデータベース保存

## まとめ

第10章では、実用的なMCPエージェントの構築に成功しました。タスクマネージャーとエラーハンドラーの統合により、複雑なタスクの自動実行と障害からの自動復旧が可能になりました。

これは「Claude Code」のようなCLIエージェントの基本的な実装であり、さらなる機能追加により、より高度なエージェントシステムへと発展させることができます。